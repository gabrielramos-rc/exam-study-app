name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths:
      # Code changes
      - 'src/**'
      - 'prisma/**'
      - 'package*.json'
      # Infrastructure changes
      - 'Dockerfile'
      - 'k8s/**'
      - '.github/workflows/**'
      # Config changes
      - 'tsconfig.json'
      - 'next.config.*'
      - 'tailwind.config.*'

# Cancel in-progress reviews when new commits are pushed
concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  claude-review:
    name: Claude Review
    runs-on: ubuntu-latest
    # Skip draft PRs
    if: github.event.pull_request.draft == false
    # Allow failure if token not configured
    continue-on-error: true

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for better diff analysis

      - name: Get PR info
        id: pr-info
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "is_dependabot=${{ github.actor == 'dependabot[bot]' }}" >> $GITHUB_OUTPUT
          echo "event_action=${{ github.event.action }}" >> $GITHUB_OUTPUT
          echo "head_sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          echo "base_sha=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT

          # Count changed files by category
          CHANGED_FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only || echo "")
          echo "has_src_changes=$(echo "$CHANGED_FILES" | grep -q '^src/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_prisma_changes=$(echo "$CHANGED_FILES" | grep -q '^prisma/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_k8s_changes=$(echo "$CHANGED_FILES" | grep -q '^k8s/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_docker_changes=$(echo "$CHANGED_FILES" | grep -qE '^Dockerfile|docker-compose' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_workflow_changes=$(echo "$CHANGED_FILES" | grep -q '^\.github/workflows/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Run Claude PR Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: |
            # Claude PR Review Task

            ## Context
            - Repository: ${{ github.repository }}
            - PR Number: #${{ github.event.pull_request.number }}
            - PR Title: ${{ github.event.pull_request.title }}
            - Author: ${{ github.event.pull_request.user.login }}
            - Event: ${{ github.event.action }}
            - Head SHA: ${{ steps.pr-info.outputs.head_sha }}
            - Base Branch: ${{ github.event.pull_request.base.ref }}
            - Is Dependabot: ${{ steps.pr-info.outputs.is_dependabot }}

            ## Changed Areas
            - Source code: ${{ steps.pr-info.outputs.has_src_changes }}
            - Prisma/Database: ${{ steps.pr-info.outputs.has_prisma_changes }}
            - Kubernetes: ${{ steps.pr-info.outputs.has_k8s_changes }}
            - Docker: ${{ steps.pr-info.outputs.has_docker_changes }}
            - GitHub Workflows: ${{ steps.pr-info.outputs.has_workflow_changes }}

            ## Your Task

            Review this PR comprehensively with **smart comment management** to avoid duplicates.

            ---

            ## PHASE 1: Gather Context

            ### Step 1.1: Get existing review comments

            First, fetch ALL existing review comments on this PR to avoid duplicates:

            ```bash
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
              --paginate \
              --jq '.[] | {id: .id, path: .path, line: .line, original_line: .original_line, body: .body, in_reply_to_id: .in_reply_to_id, user: .user.login, created_at: .created_at}'
            ```

            Store these in memory. Group them by conversation (using `in_reply_to_id` to find thread roots).

            ### Step 1.2: Get the diff

            ```bash
            gh pr diff ${{ github.event.pull_request.number }}
            ```

            ---

            ## PHASE 2: Review Against Checklist

            Review the diff against these criteria (adapt based on what changed):

            **Code Quality:**
            - Clean code principles, DRY, appropriate abstractions
            - TypeScript: proper typing, no `any` abuse, null safety
            - React: hooks rules, proper key props, memo/callback usage
            - Error handling and edge cases

            **Security (CRITICAL):**
            - Injection vulnerabilities (SQL, XSS, command injection)
            - Authentication/authorization gaps
            - Hardcoded secrets, API keys, credentials
            - Input validation and sanitization
            - OWASP Top 10 issues

            **Performance:**
            - N+1 query patterns
            - Unnecessary re-renders
            - Large bundle additions
            - Blocking operations

            **Database (if Prisma changes):**
            - Migration safety and reversibility
            - Index considerations
            - Data integrity constraints

            **Kubernetes (if k8s changes):**
            - Resource limits and requests set
            - Security contexts configured
            - Image tags pinned (not :latest in prod)

            **Dependencies (if package.json changes):**
            - New dependencies justified?
            - License compatibility
            - Actively maintained?

            **Tests:**
            - New code has test coverage?
            - Edge cases covered?

            ### Special Modes
            - **Dependabot PR**: Focus ONLY on security. Skip code quality.
            - **synchronize event**: Focus on changes since last review.

            ---

            ## PHASE 3: Categorize Issues (CRITICAL - Avoid Duplicates)

            For EACH issue you find, categorize it:

            ### Category A: SKIP (Already Acknowledged as Resolved)
            An existing comment addresses this issue AND:
            - A previous reply already marked it as resolved (contains "‚úÖ" or "Issue resolved")

            ‚Üí **Action: Do nothing** (already handled)

            ### Category B: RESOLVED (Issue Fixed in This Commit)
            An existing comment addresses this issue AND:
            - The problematic code has been fixed or removed in the current diff
            - No "resolved" reply exists yet

            ‚Üí **Action: Reply with "‚úÖ Issue resolved" message**

            ### Category C: REPLY (Still Unresolved)
            An existing comment addresses this issue AND:
            - Same file path
            - Same or nearby line (within ¬±5 lines)
            - Similar concern (e.g., both about SQL injection)
            - The issue is STILL present in the code

            ‚Üí **Action: Reply to existing thread** with status update

            ### Category D: NEW (Not Yet Reported)
            No existing comment matches this issue.

            ‚Üí **Action: Add to new review**

            ---

            ## PHASE 4: Execute Actions

            ### Step 4.1: Reply to RESOLVED issues (Category B)

            For each issue that was FIXED in this commit, reply with a resolved message:

            ```bash
            # NOTE: Replace <EXISTING_COMMENT_ID> with the actual comment ID from Phase 1 results
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
              -X POST \
              -f body="‚úÖ **Issue resolved** in commit \`$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-7)\`

            [Brief description of how it was fixed, e.g., 'Input is now properly sanitized using DOMPurify.']" \
              -F in_reply_to=<EXISTING_COMMENT_ID>
            ```

            ### Step 4.2: Reply to UNRESOLVED issues (Category C)

            For each issue that is STILL present:

            ```bash
            # NOTE: Replace <EXISTING_COMMENT_ID> with the actual comment ID from Phase 1 results
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
              -X POST \
              -f body="**Update after commit \`$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-7)\`:**

            This issue is still present. [Your specific observation about the current state]

            [If partial fix: explain what was fixed and what remains]" \
              -F in_reply_to=<EXISTING_COMMENT_ID>
            ```

            ### Step 4.3: Create new review with NEW findings only (Category D)

            If there are NEW issues not previously reported:

            ```bash
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
              -X POST \
              -f event="REQUEST_CHANGES" \
              -f body="<!-- CLAUDE-PR-REVIEW -->
            ## üîç Claude PR Review

            **Reviewed:** \`$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-7)\`
            **Overall:** üö® Changes Requested

            **New issues found:** N issues
            **Existing unresolved:** M issues (see thread replies above)

            ### ‚úÖ What Looks Good
            - [2-3 bullet points]

            ---
            *Review by Claude ¬∑ [View workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*" \
              -f 'comments[0][path]=<FILE_PATH>' \
              -f 'comments[0][line]=<LINE_NUMBER>' \
              -f 'comments[0][body]=üî¥ **Critical - Security Issue**
            # NOTE: Replace <FILE_PATH>, <LINE_NUMBER>, and body content with actual values from your findings
            # For multiple issues, add comments[1], comments[2], etc.:
            #   -f 'comments[1][path]=<FILE_PATH>' \
            #   -f 'comments[1][line]=<LINE_NUMBER>' \
            #   -f 'comments[1][body]=...'

            [Detailed explanation]

            **Suggestion:**
            \`\`\`ts
            // Fixed code here
            \`\`\`'
            ```

            ### Step 4.4: If NO new issues but unresolved exist

            Just post a summary (no `REQUEST_CHANGES` if only old issues):

            ```bash
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
              -X POST \
              -f event="COMMENT" \
              -f body="<!-- CLAUDE-PR-REVIEW -->
            ## üîç Claude PR Review

            **Reviewed:** \`$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-7)\`

            No new issues found. **M previously reported issues** remain unresolved - see existing threads.

            ---
            *Review by Claude*"
            ```

            ### Step 4.5: If ALL issues resolved

            ```bash
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
              -X POST \
              -f event="COMMENT" \
              -f body="<!-- CLAUDE-PR-REVIEW -->
            ## üîç Claude PR Review

            **Reviewed:** \`$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-7)\`
            **Overall:** ‚úÖ Looks Good

            All previously reported issues have been addressed. No new issues found.

            ### ‚úÖ What Looks Good
            - [2-3 bullet points about the fixes]

            ---
            *Review by Claude*"
            ```

            ---

            ## PHASE 5: Fallback

            If the `gh api` call fails (e.g., invalid line number), fall back to a regular PR comment:

            ```bash
            gh pr comment ${{ github.event.pull_request.number }} --body "<!-- CLAUDE-PR-REVIEW -->
            ## üîç Claude PR Review

            **Reviewed:** \`$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-7)\`

            ‚ö†Ô∏è Could not post inline comments. Issues found:

            ### üî¥ Critical
            - **file:line** - description

            ---
            *Review by Claude*"
            ```

            Then submit review action:
            ```bash
            gh pr review ${{ github.event.pull_request.number }} --request-changes \
              --body "Please address the issues in my comment above."
            ```

            ---

            ## Line Number Reference

            When reading diff output like:
            ```
            @@ -10,6 +10,8 @@ context
               existing line      <- line 10
            +  new line           <- line 11 (use this number)
            ```

            The `+10,8` means this hunk starts at line 10 in the new file and spans 8 lines. Count ` ` (context) and `+` (added) lines from that starting point; skip `-` (removed) lines.

          claude_args: '--allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr comment:*),Bash(gh pr review:*),Bash(gh api:*),Read,Glob,Grep"'

  # Light review for Dependabot PRs (runs in parallel, faster)
  dependabot-security-check:
    name: Dependabot Security Check
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' && github.event.pull_request.draft == false
    continue-on-error: true

    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run Security-Only Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: |
            # Dependabot PR Security Check

            PR: #${{ github.event.pull_request.number }}
            Title: ${{ github.event.pull_request.title }}

            This is a Dependabot dependency update. Perform a QUICK security-focused review:

            1. Check if this update addresses any known CVEs
            2. Look for breaking changes that might affect security
            3. Verify the update is from a legitimate source

            Use `gh pr diff ${{ github.event.pull_request.number }}` to see what changed.

            Be BRIEF. Only comment if there are security concerns. Use:

            ```bash
            gh pr comment ${{ github.event.pull_request.number }} --body "<!-- CLAUDE-DEPENDABOT-CHECK -->
            ## üîí Security Check

            [Your findings - keep it short]
            "
            ```

            If no concerns, just approve silently - no comment needed.

          claude_args: '--allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr comment:*),Bash(gh pr review:*)"'
