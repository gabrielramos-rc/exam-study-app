# Task 1.5: App Kubernetes Setup

## Context

This is Phase 1 (Project Foundation) of the Exam Study App. Previous tasks have set up the Next.js project (1.1), Tailwind/shadcn styling (1.2), Prisma database schema (1.3), and PostgreSQL via Helm (1.4). This task creates the Docker container for the Next.js application, updates any missing Kubernetes manifests, implements a health check API endpoint, and tests the full deployment to the dev namespace.

## Objective

Create a production-ready Docker image for the Next.js app and verify end-to-end deployment in the `exam-study-dev` Kubernetes namespace.

## Git Workflow

Before starting, set up your branch:

```bash
# Ensure you're on dev and up to date
git checkout dev
git pull origin dev

# Create task-specific branch
git checkout -b feature/1.5-app-kubernetes-setup
```

## Instructions

### Step 1: Create the Dockerfile

Create `Dockerfile` in the project root:

```dockerfile
# Build stage
FROM node:24-alpine AS builder

WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm ci

# Copy source
COPY . .

# Generate Prisma client
RUN npx prisma generate

# Build Next.js (standalone output)
RUN npm run build

# Production stage
FROM node:24-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production
# Required for Next.js standalone to bind to all interfaces (not just 127.0.0.1)
ENV HOSTNAME=0.0.0.0

# Copy built app (standalone output includes node_modules)
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public

# Copy Prisma (needed for migrations)
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma

# Remove npm from production image (not needed, reduces attack surface - CKS best practice)
RUN rm -rf /usr/local/lib/node_modules/npm /usr/local/bin/npm /usr/local/bin/npx

# Run as non-root user (CKS best practice)
RUN addgroup -g 1001 -S nodejs && adduser -S nextjs -u 1001

# Create directories for volumes with proper ownership
RUN mkdir -p /app/uploads /app/public/images && chown -R nextjs:nodejs /app/uploads /app/public/images

USER nextjs

EXPOSE 3000

CMD ["node", "server.js"]
```

### Step 2: Configure Next.js for Standalone Output

Update `next.config.ts` to enable standalone output (required for the Docker build):

```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  output: "standalone",
};

export default nextConfig;
```

### Step 3: Create the Health Check API Endpoint

Create `src/app/api/health/route.ts`:

```typescript
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET() {
  try {
    // Check database connectivity
    await prisma.$queryRaw`SELECT 1`;

    return NextResponse.json({
      status: "healthy",
      timestamp: new Date().toISOString(),
      database: "connected",
    });
  } catch (error) {
    console.error("Health check failed:", error);
    return NextResponse.json(
      {
        status: "unhealthy",
        timestamp: new Date().toISOString(),
        database: "disconnected",
        error: error instanceof Error ? error.message : "Unknown error",
      },
      { status: 503 }
    );
  }
}
```

### Step 4: Update the Secret to Reference Helm-Managed Credentials

The PostgreSQL password is now managed by Helm and stored in `postgres-credentials`. Update `k8s/base/secret.yaml` to work with the existing Helm secret by creating a placeholder that will be patched by Kustomize overlays:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: exam-study-secrets
  namespace: exam-study
type: Opaque
stringData:
  # These will be overridden by Kustomize patches in overlays
  # to reference the Helm-managed postgres-credentials secret
  DATABASE_URL: "postgresql://study:study@postgres-postgresql:5432/study"
```

**Note:** The actual DATABASE_URL with the correct password will be constructed by the overlays using the Helm-generated `postgres-credentials` secret.

### Step 5: Update Dev Overlay for Helm PostgreSQL Integration

Update `k8s/overlays/dev/kustomization.yaml` to patch the app deployment to use the Helm-managed credentials:

First, check the current content and add secret generation from the postgres-credentials:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: exam-study-dev

resources:
  - ../../base
  - namespace.yaml

patches:
  - path: service-nodeport.yaml

images:
  - name: ghcr.io/gabrielramos-rc/exam-study-app
    newTag: dev

# Generate exam-study-secrets with DATABASE_URL pointing to Helm PostgreSQL
secretGenerator:
  - name: exam-study-secrets
    behavior: replace
    literals:
      - DATABASE_URL=postgresql://study:$(POSTGRES_PASSWORD)@postgres-postgresql:5432/study
    options:
      disableNameSuffixHash: true

# Patch deployment to get password from postgres-credentials
patchesStrategicMerge:
  - |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: exam-study-app
      namespace: exam-study-dev
    spec:
      template:
        spec:
          initContainers:
            - name: wait-for-db
              command: ['sh', '-c', 'until nc -z postgres-postgresql 5432; do echo waiting for postgres; sleep 2; done']
          containers:
            - name: app
              env:
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgres-credentials
                      key: postgres-password
                - name: DATABASE_URL
                  value: "postgresql://study:$(POSTGRES_PASSWORD)@postgres-postgresql:5432/study"
```

**Alternative simpler approach** - Update `k8s/overlays/dev/kustomization.yaml`:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: exam-study-dev

resources:
  - ../../base
  - namespace.yaml

patches:
  - path: service-nodeport.yaml
  - path: deployment-patch.yaml

images:
  - name: ghcr.io/gabrielramos-rc/exam-study-app
    newTag: dev
```

Create `k8s/overlays/dev/deployment-patch.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: exam-study-app
spec:
  template:
    spec:
      initContainers:
        - name: wait-for-db
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z postgres-postgresql 5432; do echo waiting for postgres; sleep 2; done']
      containers:
        - name: app
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: postgres-password
            - name: DATABASE_URL
              value: "postgresql://study:$(POSTGRES_PASSWORD)@postgres-postgresql:5432/study"
```

### Step 6: Update Prod Overlay Similarly

Create `k8s/overlays/prod/deployment-patch.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: exam-study-app
spec:
  template:
    spec:
      initContainers:
        - name: wait-for-db
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z postgres-postgresql 5432; do echo waiting for postgres; sleep 2; done']
      containers:
        - name: app
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: postgres-password
            - name: DATABASE_URL
              value: "postgresql://study:$(POSTGRES_PASSWORD)@postgres-postgresql:5432/study"
```

Update `k8s/overlays/prod/kustomization.yaml` to include the patch:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: exam-study-prod

resources:
  - ../../base
  - namespace.yaml

patches:
  - path: service-nodeport.yaml
  - path: deployment-patch.yaml

images:
  - name: ghcr.io/gabrielramos-rc/exam-study-app
    newTag: latest
```

### Step 7: Update the Migration Job to Use Helm Credentials

Create `k8s/overlays/dev/migration-job-patch.yaml`:

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration
spec:
  template:
    spec:
      initContainers:
        - name: wait-for-db
          command: ['sh', '-c', 'until nc -z postgres-postgresql 5432; do echo waiting for postgres; sleep 2; done']
      containers:
        - name: migrate
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: postgres-password
            - name: DATABASE_URL
              value: "postgresql://study:$(POSTGRES_PASSWORD)@postgres-postgresql:5432/study"
```

Add to `k8s/overlays/dev/kustomization.yaml` patches:

```yaml
patches:
  - path: service-nodeport.yaml
  - path: deployment-patch.yaml
  - path: migration-job-patch.yaml
```

Create similar files for prod overlay.

### Step 8: Build the Docker Image

```bash
# Build the Docker image with the dev tag
docker build -t ghcr.io/gabrielramos-rc/exam-study-app:dev .

# Verify the image was created
docker images | grep exam-study-app
```

### Step 9: Ensure PostgreSQL is Running

```bash
# Check if PostgreSQL is running in dev namespace
kubectl get pods -n exam-study-dev -l app.kubernetes.io/name=postgresql

# If not running, run the setup script
./scripts/setup-helm-essentials.sh

# Start port-forwards
./scripts/start.sh
```

### Step 10: Deploy to Dev Namespace

```bash
# Apply the dev overlay
kubectl apply -k k8s/overlays/dev/

# Watch pods come up
kubectl get pods -n exam-study-dev -w

# Check deployment status
kubectl get deployments -n exam-study-dev
```

### Step 11: Run Database Migration

```bash
# Apply migration job
kubectl apply -f k8s/overlays/dev/migration-job-patch.yaml -n exam-study-dev
# Or if using kustomize, it should be included

# Wait for migration to complete
kubectl wait --for=condition=complete job/db-migration -n exam-study-dev --timeout=120s

# Check migration logs
kubectl logs job/db-migration -n exam-study-dev
```

### Step 12: Verify the Deployment

```bash
# Check all resources
kubectl get all -n exam-study-dev

# Check pod logs
kubectl logs -f deployment/exam-study-app -n exam-study-dev

# Test health endpoint (with port-forward or via NodePort)
kubectl port-forward svc/exam-study-app -n exam-study-dev 3000:80 &
curl http://localhost:3000/api/health

# Or access via NodePort
curl http://localhost:30001/api/health
```

### Step 13: Create a .dockerignore File

Create `.dockerignore` to optimize the build:

```
# Dependencies
node_modules
.pnpm-store

# Next.js build output
.next
out

# Version control
.git
.gitignore

# Environment files
.env
.env.*
!.env.example

# IDE
.vscode
.idea
*.swp
*.swo

# Logs
*.log
npm-debug.log*

# OS files
.DS_Store
Thumbs.db

# Test files
coverage
.nyc_output
*.test.ts
*.test.tsx
*.spec.ts
*.spec.tsx
__tests__

# Documentation
docs
*.md
!README.md

# Kubernetes manifests (not needed in image)
k8s

# Claude/AI files
.claude

# Scripts (not needed in image)
scripts
```

## Documentation Updates

After completing the implementation, update the project documentation:

### Update `.claude/docs/07-implementation-tasks.md`

Mark completed items with `[x]`:

```markdown
### 1.5 App Kubernetes Setup
**Read:** `08-deployment-guide.md` (Kubernetes Configuration section)
- [x] Create `Dockerfile` for Next.js app
- [x] Create `k8s/base/` directory structure
- [x] Create ConfigMap for app config (`k8s/base/app/configmap.yaml`)
- [x] Create App manifests:
  - [x] Deployment (`k8s/base/app/deployment.yaml`) - references `postgres-credentials` secret
  - [x] Service (`k8s/base/app/service.yaml`)
- [x] Create migration Job (`k8s/base/jobs/migration-job.yaml`)
- [x] Test: Build image and deploy to dev namespace
```

### Update `.claude/docs/06-api-specification.md`

Add the health endpoint documentation:

```markdown
### Health Check

#### Get Health Status
```http
GET /api/health
```

**Response (Healthy)**
```json
{
  "status": "healthy",
  "timestamp": "2024-01-15T10:00:00.000Z",
  "database": "connected"
}
```

**Response (Unhealthy - 503)**
```json
{
  "status": "unhealthy",
  "timestamp": "2024-01-15T10:00:00.000Z",
  "database": "disconnected",
  "error": "Connection refused"
}
```
```

### Update `.claude/docs/02-technical-architecture.md`

If the project structure section needs updating, add:

```markdown
├── Dockerfile                  # App container build
├── .dockerignore               # Docker build exclusions
```

### Update `.claude/docs/00-quick-reference.md`

Add Docker and deployment commands:

```markdown
## Docker Commands

```bash
# Build dev image
docker build -t ghcr.io/gabrielramos-rc/exam-study-app:dev .

# Build prod image
docker build -t ghcr.io/gabrielramos-rc/exam-study-app:latest .

# Run locally (for testing)
docker run -p 3000:3000 -e DATABASE_URL="..." ghcr.io/gabrielramos-rc/exam-study-app:dev
```

## Deploy to Kubernetes

```bash
# Deploy to dev
kubectl apply -k k8s/overlays/dev/

# Deploy to prod
kubectl apply -k k8s/overlays/prod/

# Check deployment status
kubectl get pods -n exam-study-dev -w
kubectl get pods -n exam-study-prod -w

# View logs
kubectl logs -f deployment/exam-study-app -n exam-study-dev
```
```

## Acceptance Criteria

Before marking this task complete, verify:

1. `Dockerfile` exists and builds successfully with `docker build -t exam-study-app:dev .`
2. `.dockerignore` exists with appropriate exclusions
3. `next.config.ts` has `output: "standalone"` configured
4. Health endpoint `/api/health` returns 200 with database status
5. Deployment patches exist in both `k8s/overlays/dev/` and `k8s/overlays/prod/`
6. Dev deployment works: `kubectl apply -k k8s/overlays/dev/` succeeds
7. App pod reaches `Running` state in `exam-study-dev` namespace
8. Health check passes: `curl http://localhost:30001/api/health` returns healthy
9. Database migration completes successfully
10. Documentation in `.claude/docs/` is updated to reflect changes
11. Task items in `07-implementation-tasks.md` are marked as complete `[x]`

## Git Completion

After all acceptance criteria pass:

```bash
# Stage all changes (including doc updates)
git add .

# Commit with conventional commit message
git commit -m "$(cat <<'EOF'
feat(k8s): add Dockerfile and app Kubernetes deployment

- Create multi-stage Dockerfile for Next.js standalone build
- Add .dockerignore for optimized builds
- Configure Next.js standalone output
- Create /api/health endpoint for liveness/readiness probes
- Add deployment patches for Helm PostgreSQL integration
- Update overlays to use postgres-credentials secret
- docs: updated deployment guide and API specification

Task: 1.5
EOF
)"

# Push branch to remote
git push -u origin feature/1.5-app-kubernetes-setup

# Create PR to dev branch
gh pr create --base dev --title "feat(k8s): App Kubernetes Setup" --body "$(cat <<'EOF'
## Summary
- Created production-ready Dockerfile for Next.js app
- Added health check API endpoint for Kubernetes probes
- Updated Kustomize overlays to integrate with Helm-managed PostgreSQL
- Verified end-to-end deployment in dev namespace

## Task Reference
Task 1.5 from implementation roadmap

## Changes
- `Dockerfile` - Multi-stage build for Next.js standalone
- `.dockerignore` - Optimized build exclusions
- `next.config.ts` - Standalone output configuration
- `src/app/api/health/route.ts` - Health check endpoint
- `k8s/overlays/dev/deployment-patch.yaml` - Helm credentials integration
- `k8s/overlays/prod/deployment-patch.yaml` - Helm credentials integration
- Updated kustomization.yaml files in both overlays

## Documentation Updated
- [ ] `07-implementation-tasks.md` - marked tasks complete
- [ ] `06-api-specification.md` - added health endpoint docs
- [ ] `02-technical-architecture.md` - added Dockerfile to structure
- [ ] `00-quick-reference.md` - added Docker and deploy commands

## Testing
- [ ] Docker image builds successfully
- [ ] App deploys to exam-study-dev namespace
- [ ] Health endpoint returns 200
- [ ] Database connection works
- [ ] Migration job completes
EOF
)"
```

## Notes

- **OUT OF SCOPE for this task:**
  - Ingress configuration (Phase 7)
  - Network policies (Phase 7)
  - RBAC configuration (Phase 7)
  - Pod security hardening beyond running as non-root (Phase 7)
  - HorizontalPodAutoscaler (Phase 7)
  - Production image publishing to GHCR (handled by CI/CD)

- **Dependencies:**
  - PostgreSQL must be running via Helm (`./scripts/setup-helm-essentials.sh`)
  - Port-forwards should be active (`./scripts/start.sh`)

- **Common Issues:**
  - If `ImagePullBackOff`: The image must be built locally first with `docker build`
  - If `CrashLoopBackOff`: Check logs with `kubectl logs` - usually DATABASE_URL issue
  - If health check fails: Ensure database is accessible and migrations ran
  - If `standalone` directory missing: Ensure `output: "standalone"` is in `next.config.ts`

- **Image Tags:**
  - Local dev builds: `ghcr.io/gabrielramos-rc/exam-study-app:dev`
  - Local prod builds: `ghcr.io/gabrielramos-rc/exam-study-app:latest`
  - CI/CD will publish these tags to GHCR after merge
