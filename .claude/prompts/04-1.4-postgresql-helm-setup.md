# Task 1.4: PostgreSQL Helm Setup

## Context

This task is part of Phase 1 (Project Foundation) for the Exam Study App. After the Prisma schema was created (Task 1.3), we now need to deploy PostgreSQL to Kubernetes using Helm. The project uses a dual-environment setup (dev and prod) with separate databases in each namespace. This task sets up PostgreSQL via the Bitnami Helm chart, generates secure random passwords, stores them in Kubernetes secrets, and runs the initial Prisma migration.

## Objective

Deploy PostgreSQL to both dev and prod Kubernetes namespaces using the Bitnami Helm chart, with randomly generated passwords stored in Kubernetes secrets, and run the initial Prisma migration.

## Git Workflow

Before starting, set up your branch:

```bash
# Ensure you're on dev and up to date
git checkout dev
git pull origin dev

# Create task-specific branch
git checkout -b feature/1.4-postgresql-helm-setup
```

## Instructions

### Step 1: Enable Kubernetes in Docker Desktop

1. Open Docker Desktop
2. Go to Settings â†’ Kubernetes
3. Check "Enable Kubernetes"
4. Click "Apply & Restart"
5. Wait for Kubernetes to be ready (green indicator)

Verify Kubernetes is running:

```bash
kubectl cluster-info
kubectl get nodes
```

Expected output should show a running cluster.

### Step 2: Create Namespaces

Create the dev and prod namespaces for the application:

```bash
kubectl create namespace exam-study-dev --dry-run=client -o yaml | kubectl apply -f -
kubectl create namespace exam-study-prod --dry-run=client -o yaml | kubectl apply -f -
```

Verify namespaces exist:

```bash
kubectl get namespaces | grep exam-study
```

### Step 3: Update `scripts/setup-helm-essentials.sh`

Update the setup-helm-essentials.sh script to add PostgreSQL installation. Add the Bitnami repo and PostgreSQL installation after Step 1 (Adding Helm repositories).

**Add after the helm repo update line (around line 63):**

Insert a new step to install PostgreSQL in both namespaces. The script should:

1. Add the Bitnami Helm repository
2. Generate random passwords using `openssl rand`
3. Create Kubernetes secrets with the credentials
4. Install PostgreSQL via Helm in both dev and prod namespaces
5. Display the credentials summary

**Add these lines after `echo -e "${GREEN}âœ“ Helm repos added${NC}"` (around line 64):**

```bash
# Step 1.5: Install PostgreSQL in dev and prod namespaces
echo ""
echo -e "${YELLOW}Step 1.5: Installing PostgreSQL databases...${NC}"

# Add Bitnami repo if not already added
helm repo add bitnami https://charts.bitnami.com/bitnami 2>/dev/null || true
helm repo update

# Function to setup PostgreSQL in a namespace
setup_postgres() {
    local NAMESPACE=$1
    local PORT=$2

    echo ""
    echo -e "${YELLOW}Setting up PostgreSQL in ${NAMESPACE}...${NC}"

    # Check if secret already exists (to preserve passwords on re-run)
    if kubectl get secret postgres-credentials -n "$NAMESPACE" &> /dev/null; then
        echo -e "${YELLOW}Using existing postgres-credentials secret${NC}"
        POSTGRES_PASSWORD=$(kubectl get secret postgres-credentials -n "$NAMESPACE" -o jsonpath='{.data.postgres-password}' | base64 -d)
    else
        # Generate random password
        POSTGRES_PASSWORD=$(openssl rand -base64 32 | tr -d '/+=' | head -c 24)

        # Create secret with credentials
        kubectl create secret generic postgres-credentials \
            --namespace "$NAMESPACE" \
            --from-literal=postgres-password="$POSTGRES_PASSWORD" \
            --from-literal=postgres-user="study" \
            --from-literal=postgres-db="study" \
            --from-literal=database-url="postgresql://study:${POSTGRES_PASSWORD}@postgres-postgresql:5432/study"
        echo -e "${GREEN}âœ“ Created postgres-credentials secret in ${NAMESPACE}${NC}"
    fi

    # Install or upgrade PostgreSQL
    if helm status postgres -n "$NAMESPACE" &> /dev/null; then
        echo -e "${YELLOW}PostgreSQL already installed in ${NAMESPACE}, upgrading...${NC}"
        helm upgrade postgres bitnami/postgresql --namespace "$NAMESPACE" \
            --set auth.username=study \
            --set auth.password="$POSTGRES_PASSWORD" \
            --set auth.database=study \
            --set primary.persistence.size=5Gi \
            --set primary.resources.requests.memory=256Mi \
            --set primary.resources.requests.cpu=250m \
            --set primary.resources.limits.memory=512Mi \
            --set primary.resources.limits.cpu=500m \
            --wait --timeout 5m
    else
        helm install postgres bitnami/postgresql --namespace "$NAMESPACE" \
            --set auth.username=study \
            --set auth.password="$POSTGRES_PASSWORD" \
            --set auth.database=study \
            --set primary.persistence.size=5Gi \
            --set primary.resources.requests.memory=256Mi \
            --set primary.resources.requests.cpu=250m \
            --set primary.resources.limits.memory=512Mi \
            --set primary.resources.limits.cpu=500m \
            --wait --timeout 5m
    fi
    echo -e "${GREEN}âœ“ PostgreSQL installed in ${NAMESPACE}${NC}"

    # Store password for later display
    if [ "$NAMESPACE" = "exam-study-dev" ]; then
        DEV_POSTGRES_PASSWORD="$POSTGRES_PASSWORD"
    else
        PROD_POSTGRES_PASSWORD="$POSTGRES_PASSWORD"
    fi
}

# Setup PostgreSQL in both namespaces
kubectl create namespace exam-study-dev --dry-run=client -o yaml | kubectl apply -f -
kubectl create namespace exam-study-prod --dry-run=client -o yaml | kubectl apply -f -

setup_postgres "exam-study-dev" "5432"
setup_postgres "exam-study-prod" "5433"

echo -e "${GREEN}âœ“ PostgreSQL installed in both namespaces${NC}"
```

**Also update the credentials display section at the end of the script.** Add the following block in the credentials section (before the ArgoCD credentials):

```bash
echo -e "${BLUE}PostgreSQL (Dev - exam-study-dev):${NC}"
echo "  Host:     postgres-postgresql.exam-study-dev"
echo "  Port:     5432 (cluster) / 5432 (port-forward)"
echo "  Database: study"
echo "  Username: study"
DEV_PW=$(kubectl get secret postgres-credentials -n exam-study-dev -o jsonpath='{.data.postgres-password}' 2>/dev/null | base64 -d || echo "N/A")
echo "  Password: ${DEV_PW}"
echo ""
echo -e "${BLUE}PostgreSQL (Prod - exam-study-prod):${NC}"
echo "  Host:     postgres-postgresql.exam-study-prod"
echo "  Port:     5432 (cluster) / 5433 (port-forward)"
echo "  Database: study"
echo "  Username: study"
PROD_PW=$(kubectl get secret postgres-credentials -n exam-study-prod -o jsonpath='{.data.postgres-password}' 2>/dev/null | base64 -d || echo "N/A")
echo "  Password: ${PROD_PW}"
echo ""
```

### Step 4: Update `scripts/setup-helm.sh`

Apply the same PostgreSQL setup changes to the full setup-helm.sh script. Add the same code blocks as Step 3:

1. Add the Bitnami repo and PostgreSQL installation after Step 1
2. Add the PostgreSQL credentials display in the summary section

### Step 5: Update `scripts/teardown-helm-essentials.sh`

Add PostgreSQL cleanup to the teardown script. **Add after the Helm uninstall section:**

```bash
# Uninstall PostgreSQL from both namespaces
if helm status postgres -n exam-study-dev &> /dev/null; then
    helm uninstall postgres -n exam-study-dev
    echo -e "${GREEN}âœ“ PostgreSQL (dev) uninstalled${NC}"
fi

if helm status postgres -n exam-study-prod &> /dev/null; then
    helm uninstall postgres -n exam-study-prod
    echo -e "${GREEN}âœ“ PostgreSQL (prod) uninstalled${NC}"
fi
```

**Add to the namespace deletion section:**

```bash
kubectl delete namespace exam-study-dev --wait=false 2>/dev/null || true
kubectl delete namespace exam-study-prod --wait=false 2>/dev/null || true
```

### Step 6: Update `scripts/teardown-helm.sh`

Apply the same PostgreSQL cleanup changes to the full teardown script as in Step 5.

### Step 7: Update `scripts/start.sh`

Add PostgreSQL port-forward setup to the start script. **Add after the existing port-forward blocks:**

```bash
# PostgreSQL Dev (5432)
if kubectl get svc postgres-postgresql -n exam-study-dev &> /dev/null; then
    kubectl port-forward svc/postgres-postgresql -n exam-study-dev 5432:5432 &> /dev/null &
    sleep 1
    if lsof -i :5432 &> /dev/null; then
        echo -e "${GREEN}âœ“ PostgreSQL Dev: localhost:5432${NC}"
    else
        echo -e "${RED}âœ— PostgreSQL Dev port-forward failed${NC}"
    fi
else
    echo -e "${YELLOW}âš  PostgreSQL (dev) not installed${NC}"
fi

# PostgreSQL Prod (5433)
if kubectl get svc postgres-postgresql -n exam-study-prod &> /dev/null; then
    kubectl port-forward svc/postgres-postgresql -n exam-study-prod 5433:5432 &> /dev/null &
    sleep 1
    if lsof -i :5433 &> /dev/null; then
        echo -e "${GREEN}âœ“ PostgreSQL Prod: localhost:5433${NC}"
    else
        echo -e "${RED}âœ— PostgreSQL Prod port-forward failed${NC}"
    fi
else
    echo -e "${YELLOW}âš  PostgreSQL (prod) not installed${NC}"
fi
```

**Add to the cleanup section at the top:**

```bash
pkill -f "port-forward.*postgres-postgresql" 2>/dev/null || true
```

### Step 8: Update `scripts/stop.sh`

Add PostgreSQL port-forward cleanup. **Add in the port-forward stop section:**

```bash
# PostgreSQL Dev
if pgrep -f "port-forward.*postgres-postgresql.*exam-study-dev" > /dev/null; then
    pkill -f "port-forward.*postgres-postgresql.*exam-study-dev"
    echo -e "${GREEN}âœ“ PostgreSQL Dev port-forward stopped${NC}"
else
    echo "  PostgreSQL Dev port-forward was not running"
fi

# PostgreSQL Prod
if pgrep -f "port-forward.*postgres-postgresql.*exam-study-prod" > /dev/null; then
    pkill -f "port-forward.*postgres-postgresql.*exam-study-prod"
    echo -e "${GREEN}âœ“ PostgreSQL Prod port-forward stopped${NC}"
else
    echo "  PostgreSQL Prod port-forward was not running"
fi
```

### Step 9: Run Setup and Verify PostgreSQL

Run the essentials setup script to install PostgreSQL:

```bash
./scripts/setup-helm-essentials.sh
```

Verify PostgreSQL is running in both namespaces:

```bash
# Check Helm releases
helm list -A | grep postgres

# Check pods
kubectl get pods -n exam-study-dev | grep postgres
kubectl get pods -n exam-study-prod | grep postgres

# Check secrets
kubectl get secret postgres-credentials -n exam-study-dev
kubectl get secret postgres-credentials -n exam-study-prod

# Verify connection (dev)
kubectl exec -it deploy/postgres-postgresql -n exam-study-dev -- psql -U study -d study -c "SELECT 1;"
```

### Step 10: Start Port-Forwards and Run Migration

Start port-forwards:

```bash
./scripts/start.sh
```

Verify port-forwards are running:

```bash
lsof -i :5432  # Dev database
lsof -i :5433  # Prod database
```

Get the dev database password and update your local `.env`:

```bash
# Get the password
kubectl get secret postgres-credentials -n exam-study-dev \
  -o jsonpath='{.data.postgres-password}' | base64 -d && echo

# Update .env with the correct DATABASE_URL
# DATABASE_URL=postgresql://study:<password>@localhost:5432/study
```

Run the initial Prisma migration:

```bash
npx prisma migrate dev --name init
```

This creates the migration files in `prisma/migrations/` and applies them to the database.

### Step 11: Verify Migration

Verify the migration was successful:

```bash
# Using Prisma Studio
npx prisma studio

# Or via psql
kubectl exec -it deploy/postgres-postgresql -n exam-study-dev -- \
  psql -U study -d study -c "\dt"
```

You should see all the tables: Exam, Question, Answer, SrsCard, Bookmark, StudyProgress, Settings, and the Prisma migration tables.

### Step 12: Update .env.example

Update `.env.example` to include documentation for getting the database URL:

```bash
# Database (get password from Kubernetes secret)
# kubectl get secret postgres-credentials -n exam-study-dev -o jsonpath='{.data.postgres-password}' | base64 -d
DATABASE_URL=postgresql://study:<password>@localhost:5432/study

# App
NODE_ENV=development
PORT=3000
UPLOAD_MAX_SIZE=52428800
```

## Documentation Updates

After completing the implementation, update the project documentation:

### Update `.claude/docs/07-implementation-tasks.md`

Mark completed items with `[x]`:

```markdown
### 1.4 PostgreSQL Helm Setup
**Read:** `08-deployment-guide.md` (Kubernetes Configuration section)
- [x] Enable Kubernetes in Docker Desktop
- [x] Create namespaces (`exam-study-dev`, `exam-study-prod`)
- [x] Update `scripts/setup-helm-essentials.sh` and `scripts/setup-helm.sh`:
  - [x] Add Bitnami Helm repo
  - [x] Generate random passwords with `openssl rand`
  - [x] Store credentials in Kubernetes secrets (`postgres-credentials`)
  - [x] Install PostgreSQL via Helm to both namespaces
  - [x] Display credentials summary
- [x] Update `scripts/teardown-helm-essentials.sh` and `scripts/teardown-helm.sh` for cleanup
- [x] Update `scripts/start.sh` with PostgreSQL port-forwards:
  - [x] Dev database on port 5432
  - [x] Prod database on port 5433
- [x] Update `scripts/stop.sh`
- [x] Run initial Prisma migration (`npx prisma migrate dev --name init`)
- [x] Verify with `npx prisma studio`
```

### Update `.claude/docs/08-deployment-guide.md`

Update the Database Management section to reflect Helm-based PostgreSQL setup:

```markdown
### PostgreSQL (via Helm)

PostgreSQL is installed via the Bitnami Helm chart in each namespace:

```bash
# Check PostgreSQL status
kubectl get pods -n exam-study-dev -l app.kubernetes.io/name=postgresql
kubectl get pods -n exam-study-prod -l app.kubernetes.io/name=postgresql

# View credentials
kubectl get secret postgres-credentials -n exam-study-dev -o jsonpath='{.data.postgres-password}' | base64 -d

# Database shell (dev)
kubectl exec -it deploy/postgres-postgresql -n exam-study-dev -- psql -U study -d study

# Database shell (prod)
kubectl exec -it deploy/postgres-postgresql -n exam-study-prod -- psql -U study -d study
```
```

### Update `.claude/docs/00-quick-reference.md`

Update the Kubernetes section with PostgreSQL commands:

```markdown
## PostgreSQL (Helm)

```bash
# Setup (included in setup-helm-essentials.sh)
helm install postgres bitnami/postgresql -n exam-study-dev \
  --set auth.username=study --set auth.database=study

# Port-forward (automated via start.sh)
kubectl port-forward svc/postgres-postgresql -n exam-study-dev 5432:5432 &
kubectl port-forward svc/postgres-postgresql -n exam-study-prod 5433:5432 &

# Get password
kubectl get secret postgres-credentials -n exam-study-dev \
  -o jsonpath='{.data.postgres-password}' | base64 -d

# Database shell
kubectl exec -it deploy/postgres-postgresql -n exam-study-dev -- psql -U study -d study

# Verify connection
kubectl exec deploy/postgres-postgresql -n exam-study-dev -- pg_isready -U study
```
```

### Update `.claude/docs/10-infrastructure-access.md`

If this file exists, update it with PostgreSQL access information. If not, create a section in the deployment guide.

## Acceptance Criteria

Before marking this task complete, verify:

1. Kubernetes is enabled in Docker Desktop:
   - [ ] `kubectl cluster-info` returns cluster info
   - [ ] `kubectl get nodes` shows a ready node

2. Namespaces exist:
   - [ ] `kubectl get namespace exam-study-dev` succeeds
   - [ ] `kubectl get namespace exam-study-prod` succeeds

3. PostgreSQL is running via Helm:
   - [ ] `helm list -A | grep postgres` shows releases in both namespaces
   - [ ] `kubectl get pods -n exam-study-dev | grep postgres` shows running pod
   - [ ] `kubectl get pods -n exam-study-prod | grep postgres` shows running pod

4. Secrets are created with random passwords:
   - [ ] `kubectl get secret postgres-credentials -n exam-study-dev` exists
   - [ ] `kubectl get secret postgres-credentials -n exam-study-prod` exists
   - [ ] Passwords are different between dev and prod

5. Scripts are updated:
   - [ ] `scripts/setup-helm-essentials.sh` installs PostgreSQL in both namespaces
   - [ ] `scripts/setup-helm.sh` installs PostgreSQL in both namespaces
   - [ ] `scripts/teardown-helm-essentials.sh` removes PostgreSQL from both namespaces
   - [ ] `scripts/teardown-helm.sh` removes PostgreSQL from both namespaces
   - [ ] `scripts/start.sh` port-forwards PostgreSQL (dev:5432, prod:5433)
   - [ ] `scripts/stop.sh` stops PostgreSQL port-forwards

6. Migration is successful:
   - [ ] `prisma/migrations/` directory contains init migration
   - [ ] `npx prisma studio` shows all 7 tables
   - [ ] Database connection works via localhost:5432

7. Documentation updated:
   - [ ] `07-implementation-tasks.md` - tasks marked complete
   - [ ] `08-deployment-guide.md` - PostgreSQL Helm instructions added
   - [ ] `00-quick-reference.md` - PostgreSQL commands added

## Git Completion

After all acceptance criteria pass:

```bash
# Stage all changes (including doc updates)
git add .

# Commit with conventional commit message
git commit -m "$(cat <<'EOF'
feat(db): set up PostgreSQL via Helm with random passwords

- Update setup-helm scripts to install PostgreSQL in dev/prod namespaces
- Use Bitnami PostgreSQL Helm chart
- Generate random passwords with openssl, store in Kubernetes secrets
- Add port-forward setup to start.sh (dev:5432, prod:5433)
- Add cleanup to teardown scripts and stop.sh
- Run initial Prisma migration
- docs: updated deployment guide and quick reference

Task: 1.4

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"

# Push branch to remote
git push -u origin feature/1.4-postgresql-helm-setup

# Create PR to dev branch
gh pr create --base dev --title "feat(db): Set up PostgreSQL via Helm" --body "$(cat <<'EOF'
## Summary
Set up PostgreSQL in Kubernetes using Bitnami Helm chart for both dev and prod environments.

## Task Reference
Task 1.4 from implementation roadmap

## Changes
- Updated `scripts/setup-helm-essentials.sh`:
  - Added Bitnami Helm repository
  - Installs PostgreSQL in exam-study-dev and exam-study-prod namespaces
  - Generates random passwords using `openssl rand`
  - Creates `postgres-credentials` secret with password, username, database, and DATABASE_URL
  - Displays credentials in summary

- Updated `scripts/setup-helm.sh` with same PostgreSQL setup

- Updated `scripts/teardown-helm-essentials.sh` and `scripts/teardown-helm.sh`:
  - Uninstalls PostgreSQL Helm releases
  - Deletes exam-study-dev and exam-study-prod namespaces

- Updated `scripts/start.sh`:
  - Adds port-forward for dev database on port 5432
  - Adds port-forward for prod database on port 5433

- Updated `scripts/stop.sh`:
  - Stops PostgreSQL port-forwards

- Created initial Prisma migration (`prisma/migrations/`)

## Documentation Updated
- [x] `07-implementation-tasks.md` - marked tasks complete
- [x] `08-deployment-guide.md` - added PostgreSQL Helm instructions
- [x] `00-quick-reference.md` - added PostgreSQL commands

## Testing
- [x] Kubernetes cluster running
- [x] PostgreSQL pods running in both namespaces
- [x] Secrets created with random passwords
- [x] Port-forwards working (5432, 5433)
- [x] Prisma migration successful
- [x] All 7 tables created in database
EOF
)"
```

## Notes

- **OUT OF SCOPE**: Do not create the App Kubernetes manifests (Dockerfile, Deployment, Service) - that's Task 1.5
- **OUT OF SCOPE**: Do not create the layout or navigation components - that's Task 1.6
- **OUT OF SCOPE**: Do not create API endpoints - that's Phase 2
- The Bitnami PostgreSQL Helm chart is well-maintained and follows best practices
- Random passwords are generated once per namespace and preserved on script re-runs
- The `postgres-credentials` secret contains all needed values including the full `database-url`
- Port 5432 is for dev, port 5433 is for prod to avoid conflicts
- Always use the secrets to get credentials rather than hardcoding passwords
- If you need to reset passwords, delete the `postgres-credentials` secret before running setup
- The migration creates all tables defined in `prisma/schema.prisma`
