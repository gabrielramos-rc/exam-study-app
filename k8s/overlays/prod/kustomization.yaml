apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: exam-study-app-prod

# Reference the base configuration
resources:
  - ../../base
  - service-nodeport.yaml

# Override namespace for all resources
namespace: exam-study-prod

# Add prod-specific labels
labels:
  - pairs:
      environment: prod

# Patches for prod-specific changes (consolidated)
patches:
  # Helm PostgreSQL integration - update init container and replace env array
  - target:
      kind: Deployment
      name: exam-study-app
    patch: |
      - op: replace
        path: /spec/template/spec/initContainers/0/command
        value: ['sh', '-c', 'timeout 120 sh -c "until nc -z postgres-postgresql 5432; do echo waiting for postgres; sleep 2; done"']
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: HOSTNAME
            value: "0.0.0.0"
          - name: DATABASE_URL
            valueFrom:
              secretKeyRef:
                name: postgres-credentials
                key: database-url

  # Helm PostgreSQL integration - migration job
  - target:
      kind: Job
      name: db-migration
    patch: |
      - op: replace
        path: /spec/template/spec/initContainers/0/command
        value: ['sh', '-c', 'timeout 120 sh -c "until nc -z postgres-postgresql 5432; do echo waiting for postgres; sleep 2; done"']
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: DATABASE_URL
            valueFrom:
              secretKeyRef:
                name: postgres-credentials
                key: database-url

  # Use stable image tag and higher replicas for prod
  - target:
      kind: Deployment
      name: exam-study-app
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: ghcr.io/gabrielramos-rc/exam-study-app:latest
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
      - op: replace
        path: /spec/replicas
        value: 2

  # Higher resources for prod
  - target:
      kind: Deployment
      name: exam-study-app
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "256Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "250m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "512Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "500m"

  # Update migration job to use dedicated lightweight migration image
  - target:
      kind: Job
      name: db-migration
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: ghcr.io/gabrielramos-rc/exam-study-app-migrate:latest
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent

  # Higher resources for postgres in prod
  - target:
      kind: Deployment
      name: postgres
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "512Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "1Gi"

  # Larger PVC for prod
  - target:
      kind: PersistentVolumeClaim
      name: postgres-pvc
    patch: |
      - op: replace
        path: /spec/resources/requests/storage
        value: 10Gi

# Image tag override
images:
  - name: ghcr.io/gabrielramos-rc/exam-study-app
    newTag: latest
  - name: ghcr.io/gabrielramos-rc/exam-study-app-migrate
    newTag: latest
