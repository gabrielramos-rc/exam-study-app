apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: exam-study-app-dev

# Reference the base configuration
resources:
  - ../../base
  - namespace.yaml
  - service-nodeport.yaml

# Override namespace for all resources
namespace: exam-study-dev

# Add dev-specific labels
commonLabels:
  environment: dev

# Add name suffix to avoid conflicts
nameSuffix: ""

# Patches for dev-specific changes
patches:
  # Use dev image tag
  - target:
      kind: Deployment
      name: exam-study-app
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: ghcr.io/gabrielramos-rc/exam-study-app:dev
      - op: replace
        path: /spec/replicas
        value: 1

  # Lower resources for dev
  - target:
      kind: Deployment
      name: exam-study-app
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "128Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "100m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "256Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "250m"

  # Update migration job image
  - target:
      kind: Job
      name: db-migration
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: ghcr.io/gabrielramos-rc/exam-study-app:dev

  # Smaller PVC for dev
  - target:
      kind: PersistentVolumeClaim
      name: postgres-pvc
    patch: |
      - op: replace
        path: /spec/resources/requests/storage
        value: 1Gi

# ConfigMap overrides for dev
configMapGenerator:
  - name: exam-study-config
    behavior: merge
    literals:
      - NODE_ENV=development

# Image tag override (alternative method)
images:
  - name: ghcr.io/gabrielramos-rc/exam-study-app
    newTag: dev
