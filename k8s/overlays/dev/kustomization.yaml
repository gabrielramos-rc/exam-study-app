apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: exam-study-app-dev

# Reference the base configuration
resources:
  - ../../base
  - service-nodeport.yaml

# Override namespace for all resources
namespace: exam-study-dev

# Add dev-specific labels
labels:
  - pairs:
      environment: dev

# Patches for dev-specific changes (consolidated)
patches:
  # Helm PostgreSQL integration - update init container and replace env array
  - target:
      kind: Deployment
      name: exam-study-app
    patch: |
      - op: replace
        path: /spec/template/spec/initContainers/0/command
        value: ['sh', '-c', 'until nc -z postgres-postgresql 5432; do echo waiting for postgres; sleep 2; done']
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: HOSTNAME
            value: "0.0.0.0"
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: postgres-credentials
                key: postgres-password
          - name: DATABASE_URL
            value: "postgresql://study:$(POSTGRES_PASSWORD)@postgres-postgresql:5432/study"

  # Helm PostgreSQL integration - migration job
  - target:
      kind: Job
      name: db-migration
    patch: |
      - op: replace
        path: /spec/template/spec/initContainers/0/command
        value: ['sh', '-c', 'until nc -z postgres-postgresql 5432; do echo waiting for postgres; sleep 2; done']
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: postgres-credentials
                key: postgres-password
          - name: DATABASE_URL
            value: "postgresql://study:$(POSTGRES_PASSWORD)@postgres-postgresql:5432/study"

  # Use dev image tag, lower replicas, and Never pull for local images
  - target:
      kind: Deployment
      name: exam-study-app
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: ghcr.io/gabrielramos-rc/exam-study-app:dev
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: replace
        path: /spec/replicas
        value: 1

  # Lower resources for dev
  - target:
      kind: Deployment
      name: exam-study-app
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "128Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "100m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "256Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "250m"

  # Update migration job image with Never pull for local images
  - target:
      kind: Job
      name: db-migration
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: ghcr.io/gabrielramos-rc/exam-study-app:dev
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never

  # Smaller PVC for dev
  - target:
      kind: PersistentVolumeClaim
      name: postgres-pvc
    patch: |
      - op: replace
        path: /spec/resources/requests/storage
        value: 1Gi

# Image tag override
images:
  - name: ghcr.io/gabrielramos-rc/exam-study-app
    newTag: dev
